{% extends 'base.html' %}

{% block style %}
<link rel="stylesheet" href="{{ url_for('static', filename='statistics/style.css') }}">
{% endblock %}

{% block head %}
<title>Statistics</title>
{% endblock %}

{% block body %}
<div class="container">
    <h3>Model overview</h3>
    Our experimented models, in general, can be interpreted as 3 main modules:
    <ul>
        <li>Spacial features extractor module</li>
        <li>Temporal features extractor module</li>
        <li>Decision maker module</li>
    </ul>

    <h4>Spacial features extractor module (backbone)</h4>
    The first part of the models is designed as an automatic feature extractor for each frame of the video segement. Here, by utilizing some of the most popular pretrained models, which are mainly used for image classifier task, like Mobilenet, VGG16, Inception, etc.
    Using transfer learning technique, with the help of the <a href="#">Accident image dataset</a>, the pretrained model has properly adjusted its weights to recognize accident features, ready to become the spatial extractor for the accident detection model.
    After transfer learning (using the same image dataset mentioned before), we have experimented by pluging them one by one to the main purpose model (freezing all the weights), then compare the result to se which one does the best job.
    A time distributed is wrap arount this module so that it could go through all frames in the video segemnt, make it ready for taking the next step, input to the emporal features extractor module.

    <h4>Temporal features extractor module</h4>
    After each frames has been extracted it accident features, which are independent from the temporal feature, the features of a frame has no information about the features of previous frames, which isn't an efficient way to interpret an accident context.
    Because of that, bringing the temporal features extractor module as the next module, continuous processing the time axis of videos.
    Taking advantage of some of best achitecture such as ConvLSTM, GRU, Conv3D, etc. Out of them, by comparing between accuracy scores and some other metrics, we choose Conv3D as it gives the best result in general.

    <h4>Decision maker module</h4>
    When both the spatial and temporal features have been extracted, it is time for the model to declare whether there is any accident in the video segment. Hence bringing the last module as the dicision maker module, structed by several dense layers with the last layer consists of just one neuron.
    This module will produce a possibility that a video segment contains accident. If the possibility is greater than a threshold (which is decided by looking at elbow curve of the thresholds used to compute ROC curve), then the video is predicted as having accident, else it is declared that no accident has occured.

    <!-- Curves -->

    <h3>Backbone and Model training curves</h3>
    <div class="d-flex align-items-start">
        <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                  All
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                    <li class="dropdown-item" href="#" id="v-pills-all-tab">All</li>
                    {% for info in backbone_info %}
                        {% set name = info.name.replace(" ", "").lower() %}
                        <li class="dropdown-item" href="#" id="v-pills-{{ name }}-tab" >{{ info.name }}</li>
                    {% endfor %}
                </ul>
              </div>
        </div>
        <div class="tab-content" id="v-pills-tabContent">
            {% for info in backbone_info %}
                {% set name = info.name.replace(" ", "").lower() %}
                <div class="tab-pane fade {{ 'active' if loop.index == 1 else '' }}" id="v-pills-{{ name }}" role="tabpanel" aria-labelledby="v-pills-{{ name }}-tab">{{ info.name }}</div>
            {% endfor %}
        </div>
    </div>

    

    <div class="charts">
        <div>
            <canvas id="model-train-accuracy-chart"></canvas>
        </div>
        
        <div>
            <canvas id="model_val_accuracy"></canvas>
        </div>
        
        <div>
            <canvas id="model_train_loss"></canvas>
        </div>
        
        <div>
            <canvas id="model_val_loss"></canvas>
        </div>

        <div>
            <canvas id="ROC-chart"></canvas>
        </div>

        <div>
            <canvas id="optiomal-threshold-chart"></canvas>
        </div>

        <div>
            <canvas id="AUC-chart"></canvas>
        </div>

        <div>
            <div id="cm"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    class BackboneInfo {
        constructor(name, fpr, tpr, tresholds, auc, backbone_train_accuracy, backbone_val_accuracy, backbone_train_loss, backbone_val_loss, model_train_accuracy, model_val_accuracy, model_train_loss, model_val_loss) {
            this.name = name;
            this.fpr = fpr;
            this.tpr = tpr;
            this.tresholds = tresholds;
            this.auc = auc;
            this.backbone_train_accuracy = backbone_train_accuracy;
            this.backbone_val_accuracy = backbone_val_accuracy;
            this.backbone_train_loss = backbone_train_loss;
            this.backbone_val_loss = backbone_val_loss;
            this.model_train_accuracy = model_train_accuracy;
            this.model_val_accuracy = model_val_accuracy;
            this.model_train_loss = model_train_loss;
            this.model_val_loss = model_val_loss;

            this.epochs = [...Array(model_train_accuracy.length).keys()]; // creat array from 0->n-1
            this.epochs.shift(); // remove 0 => 1->n-1
            this.epochs.push(model_train_accuracy.length) // add n => 1->n
        }
    }
    
    const backbone_info = [];
    {% for info in backbone_info %}
        backbone_info.push(
            new BackboneInfo(
                "{{ info.name }}",
                {{ info.fpr }},
                {{ info.tpr }},
                {{ info.tresholds }},
                {{ info.auc }},
                {{ info.backbone_train_accuracy }},
                {{ info.backbone_val_accuracy }},
                {{ info.backbone_train_loss }},
                {{ info.backbone_val_loss }},
                {{ info.model_train_accuracy }},
                {{ info.model_val_accuracy }},
                {{ info.model_train_loss }},
                {{ info.model_val_loss }}
            ));
    {% endfor %}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='statistics/script.js') }}"></script>
{% endblock %}
